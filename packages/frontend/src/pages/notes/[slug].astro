---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/header/Header.astro";
import Main from "@/components/main/Main.astro";

import { Note } from "@/models";

const { getToken } = Astro.locals.auth();
const token = await getToken();

const ASTRO_API_URL = process.env.ASTRO_API_URL as string;
let data: Array<Note>;
try {
    const resp = await fetch(`${ASTRO_API_URL}/notes`, {
        method: "GET",
        headers: {
            Authorization: `Bearer ${token}`,
        },
    });

    data = await resp.json();
    console.log("~data from endpoint:", JSON.stringify(data));
} catch (e) {
    console.error(e);
}

const pages = data!.map(function (d: Note) {
    return {
        ...d,
        slug: d.noteId,
    };
});

const { slug } = Astro.params;
const page = pages.find((page) => page.slug === slug);
if (!page) return Astro.redirect("/404");
---

<Layout>
    <Header />
    <Main
        ><section>
            <header><p>date: {page.createdAt}</p></header>
            <main><p>{page.content}</p></main>
        </section></Main
    >
</Layout>
